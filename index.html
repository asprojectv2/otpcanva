<!DOCTYPE html>
<html lang="id"> <!-- Kelas tema akan ditambahkan oleh JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CANVA OTP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Script untuk mencegah flash tema yang salah (FOUC)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Animasi untuk item baru di daftar */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .new-item {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Animasi untuk highlight OTP baru */
        @keyframes newOtpHighlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        .new-otp-item {
            animation: newOtpHighlight 0.8s ease-in-out;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-400 */
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Tombol Tema -->
    <button id="theme-toggle" class="fixed top-4 right-4 p-2 rounded-full bg-slate-200 dark:bg-gray-700 text-slate-600 dark:text-gray-300 hover:bg-slate-300 dark:hover:bg-gray-600 transition-all duration-300">
        <!-- Ikon akan diisi oleh JS -->
    </button>

    <div class="w-full max-w-lg mx-auto pt-16 pb-4 px-4">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-white">
                <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-transparent bg-clip-text">CANVA OTP</span>
            </h1>
            <p class="text-slate-500 dark:text-gray-400 mt-2">Premium Canva OTP Fetcher by AS</p>
        </header>

        <!-- Kontrol Utama -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8 transition-colors duration-300">
            <div class="mb-4">
                <label for="email-input" class="block text-sm font-medium text-slate-600 dark:text-gray-300 mb-2">Email</label>
                <input type="text" id="email-input" class="w-full bg-slate-100 dark:bg-gray-700 border-slate-300 dark:border-gray-600 text-slate-900 dark:text-white rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300" placeholder="Generate atau masukkan satu email..."/>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Generate</button>
                <button id="copy-email-btn" class="w-full bg-slate-500 hover:bg-slate-600 dark:bg-gray-600 dark:hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Copy Email</button>
                <button id="toggle-monitor-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cek OTP</button>
                <button id="clear-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Bersihkan</button>
            </div>
        </div>

        <!-- Hasil OTP -->
        <div id="status-container" class="text-center mb-4 h-6"></div>
        <div id="results-container">
            <!-- Kartu hasil akan ditambahkan di sini oleh JavaScript -->
        </div>

    </div>

    <script>
        // --- Konfigurasi ---
        const POLLING_INTERVAL = 2000; // Cek setiap 2 detik
        const MONITORING_DURATION = 20000; // Berhenti setelah 20 detik
        const API_BASE_URL = "https://mailgo.site/api/messages";

        // --- Variabel Global ---
        let pollingInterval = null;
        let stopTimeout = null;
        let countdownInterval = null;
        let usedMessageIds = {};

        // --- Elemen DOM ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const generateBtn = document.getElementById('generate-btn');
        const copyEmailBtn = document.getElementById('copy-email-btn');
        const toggleBtn = document.getElementById('toggle-monitor-btn');
        const clearBtn = document.getElementById('clear-btn');
        const emailInput = document.getElementById('email-input');
        const resultsContainer = document.getElementById('results-container');
        const statusContainer = document.getElementById('status-container');

        // --- Logika Tema ---
        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.95l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" clip-rule="evenodd" /></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>`;

        const applyTheme = (isDark) => {
            if (isDark) {
                document.documentElement.classList.add('dark');
                themeToggleBtn.innerHTML = sunIcon;
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleBtn.innerHTML = moonIcon;
                localStorage.setItem('theme', 'light');
            }
        };

        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            applyTheme(!isDark);
        });

        // Terapkan tema saat load awal
        applyTheme(localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches));


        // --- Fungsi Inti ---
        function generateReadableEmail() {
            const vowels = 'aeiou';
            const consonants = 'bcdfghjklmnpqrstvwxyz';
            let username = '';
            const length = Math.floor(Math.random() * 2) + 6;
            let useVowel = Math.random() > 0.5;
            for (let i = 0; i < length; i++) {
                username += useVowel ? vowels.charAt(Math.floor(Math.random() * vowels.length)) : consonants.charAt(Math.floor(Math.random() * consonants.length));
                useVowel = !useVowel;
            }
            return `${username}@kanvapro.site`;
        }

        async function pollInbox(email) {
            try {
                const response = await fetch(`${API_BASE_URL}/${email}/aurigo`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const messages = await response.json();
                messages.reverse();

                for (const msg of messages) {
                    const isFromCanva = msg.from?.toLowerCase().includes("canva") || msg.subject?.toLowerCase().includes("canva");
                    const isNewMessage = !usedMessageIds[email].has(msg.id);

                    if (isFromCanva && isNewMessage) {
                        usedMessageIds[email].add(msg.id);
                        let otpMatches = msg.content?.match(/\b\d{6}\b/g);
                        let foundOtps = otpMatches ? [...new Set(otpMatches)].filter(otp => otp !== '000000') : [];
                        
                        const card = document.getElementById(`card-${email.replace(/[@.]/g, '-')}`);
                        if (card) {
                            const existingOtps = JSON.parse(card.dataset.otps || '[]');
                            const trulyNewOtps = foundOtps.filter(otp => !existingOtps.includes(otp));
                            if (trulyNewOtps.length > 0) {
                                const combinedOtps = [...new Set([...trulyNewOtps, ...existingOtps])];
                                card.dataset.otps = JSON.stringify(combinedOtps);
                                updateCardWithOTP(email, combinedOtps, msg.subject, trulyNewOtps);
                            } else {
                                updateCardWithOTP(email, existingOtps, msg.subject, []);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(`[${email}] Error polling:`, error);
                updateCardStatus(email, 'error');
            }
        }

        function startMonitoring() {
            const email = emailInput.value.trim();
            if (!email) {
                showStatus("⚠️ Masukkan email terlebih dahulu.", 'yellow', 3000);
                return;
            }

            resultsContainer.innerHTML = '';
            usedMessageIds = { [email]: new Set() };
            createResultCard(email);

            pollInbox(email); 
            pollingInterval = setInterval(() => pollInbox(email), POLLING_INTERVAL);
            stopTimeout = setTimeout(stopMonitoring, MONITORING_DURATION);

            let countdown = MONITORING_DURATION / 1000;
            showStatus(`📡 Memantau... sisa ${countdown} detik`, 'green');
            countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    showStatus(`📡 Memantau... sisa ${countdown} detik`, 'green');
                }
            }, 1000);

            toggleBtn.textContent = 'Hentikan';
            toggleBtn.classList.replace('bg-purple-600', 'bg-yellow-600');
            toggleBtn.classList.replace('hover:bg-purple-700', 'hover:bg-yellow-700');
            [emailInput, generateBtn, copyEmailBtn, clearBtn].forEach(el => el.disabled = true);
        }

        function stopMonitoring() {
            if (pollingInterval) clearInterval(pollingInterval);
            if (stopTimeout) clearTimeout(stopTimeout);
            if (countdownInterval) clearInterval(countdownInterval);
            
            pollingInterval = stopTimeout = countdownInterval = null;

            showStatus("⏹️ Pemantauan selesai.", 'gray', 5000);
            toggleBtn.textContent = 'Cek OTP';
            toggleBtn.classList.replace('bg-yellow-600', 'bg-purple-600');
            toggleBtn.classList.replace('hover:bg-yellow-700', 'hover:bg-purple-700');
            [emailInput, generateBtn, copyEmailBtn, clearBtn].forEach(el => el.disabled = false);
        }

        function createResultCard(email) {
            const card = document.createElement('div');
            card.id = `card-${email.replace(/[@.]/g, '-')}`;
            card.dataset.otps = '[]';
            card.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg new-item transition-colors duration-300';
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <p class="text-lg font-medium text-purple-500 dark:text-purple-400 truncate w-4/5" title="${email}">${email}</p>
                    <span id="status-${email.replace(/[@.]/g, '-')}" class="text-sm font-semibold text-slate-400 dark:text-gray-400 animate-pulse">Menunggu...</span>
                </div>
                <div id="otp-display-${email.replace(/[@.]/g, '-')}" class="bg-slate-100 dark:bg-gray-900 rounded-lg p-4 text-center min-h-[90px] flex flex-col justify-center transition-colors duration-300">
                    <p class="text-sm text-slate-500 dark:text-gray-500 mb-1">OTP DARI CANVA</p>
                    <p class="text-3xl font-bold text-slate-400 dark:text-gray-500 tracking-widest leading-tight">- - - - - -</p>
                </div>
                <div id="copy-container-${email.replace(/[@.]/g, '-')}" class="mt-4"></div>
            `;
            resultsContainer.appendChild(card);
        }
        
        function updateCardWithOTP(email, allOtps, subject, newOtps = []) {
            const cardId = `card-${email.replace(/[@.]/g, '-')}`;
            const card = document.getElementById(cardId);
            if (!card) return;

            const otpDisplayEl = document.getElementById(`otp-display-${email.replace(/[@.]/g, '-')}`);
            const statusEl = document.getElementById(`status-${email.replace(/[@.]/g, '-')}`);
            const copyContainerEl = document.getElementById(`copy-container-${email.replace(/[@.]/g, '-')}`);

            if (allOtps && allOtps.length > 0) {
                const newestOtp = allOtps[0];
                const otpHtml = allOtps.map(otp => {
                    const isNew = newOtps.includes(otp);
                    const colorClass = isNew ? 'text-yellow-500 dark:text-yellow-400' : 'text-green-600 dark:text-green-400';
                    return `<span class="relative inline-block px-2 ${isNew ? 'new-otp-item' : ''} font-bold ${colorClass}">${otp}</span>`;
                }).join('<span class="mx-1 text-slate-400 dark:text-gray-600">|</span>');
                
                otpDisplayEl.innerHTML = `<p class="text-sm text-slate-500 dark:text-gray-500 mb-1">OTP DARI CANVA</p><p class="text-3xl font-bold tracking-normal leading-tight">${otpHtml}</p>`;
                copyContainerEl.innerHTML = `<button onclick="copyToClipboard('${newestOtp}', this)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Copy OTP Terbaru (${newestOtp})</button>`;
                statusEl.textContent = 'Ditemukan!';
                statusEl.className = 'text-sm font-semibold text-green-600 dark:text-green-400';
                card.classList.add('border-green-500');
            } else {
                if (!card.dataset.hasResult) {
                    otpDisplayEl.innerHTML = `<p class="text-sm text-slate-500 dark:text-gray-500 mb-1">OTP DARI CANVA</p><p class="text-3xl font-bold text-red-500 dark:text-red-400 tracking-normal leading-tight">Tidak Ditemukan</p>`;
                    statusEl.textContent = 'Tidak ada OTP';
                    statusEl.className = 'text-sm font-semibold text-red-500 dark:text-red-400';
                }
            }
            if (allOtps.length > 0) card.dataset.hasResult = "true";
            statusEl.classList.remove('animate-pulse');
        }

        function updateCardStatus(email, statusType) {
            const statusEl = document.getElementById(`status-${email.replace(/[@.]/g, '-')}`);
            if (statusEl && statusType === 'error') {
                statusEl.textContent = 'Error';
                statusEl.className = 'text-sm font-semibold text-red-500 dark:text-red-400';
                statusEl.classList.remove('animate-pulse');
            }
        }
        
        function showStatus(message, color, duration = 0) {
            const colorClasses = {
                green: 'text-green-600 dark:text-green-400',
                yellow: 'text-yellow-500 dark:text-yellow-400',
                red: 'text-red-500 dark:text-red-400',
                blue: 'text-blue-500 dark:text-blue-400',
                gray: 'text-slate-500 dark:text-gray-400'
            };
            statusContainer.textContent = message;
            statusContainer.className = `text-center mb-4 h-6 ${colorClasses[color] || 'text-slate-500 dark:text-gray-400'}`;
            if (duration > 0) setTimeout(() => { if (statusContainer.textContent === message) statusContainer.textContent = ''; }, duration);
        }

        function copyToClipboard(text, buttonElement) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            if (buttonElement) {
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = 'Tersalin!';
                setTimeout(() => { buttonElement.innerHTML = originalText; }, 2000);
            }
        }

        // --- Event Listeners ---
        toggleBtn.addEventListener('click', () => { if (pollingInterval) stopMonitoring(); else startMonitoring(); });
        clearBtn.addEventListener('click', () => {
            if (pollingInterval) stopMonitoring();
            resultsContainer.innerHTML = '';
            emailInput.value = '';
            showStatus("🧹 Hasil & email dibersihkan.", 'gray', 3000);
        });
        generateBtn.addEventListener('click', () => {
            emailInput.value = generateReadableEmail();
            showStatus(`📧 Email baru digenerate: ${emailInput.value}`, 'blue', 4000);
        });
        copyEmailBtn.addEventListener('click', () => {
            const emailToCopy = emailInput.value;
            if (!emailToCopy) {
                showStatus("⚠️ Tidak ada email untuk disalin.", 'yellow', 3000);
                return;
            }
            copyToClipboard(emailToCopy);
            showStatus("✅ Email berhasil disalin ke clipboard!", 'green', 3000);
        });
    </script>
</body>
</html>
